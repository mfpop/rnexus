<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Auth Test</title>
</head>
<body>
    <h1>Profile Authentication Test</h1>
    <div>
        <button onclick="clearAuth()">Clear Auth Data</button>
        <button onclick="testLogin()">Test Login</button>
        <button onclick="testGraphQL()">Test GraphQL</button>
    </div>
    <div id="output"></div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        function clearAuth() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
            localStorage.removeItem('authRememberMe');
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('authUser');
            log('‚úÖ Cleared all auth data');
        }

        async function testLogin() {
            try {
                log('üîÑ Testing login...');
                const response = await fetch('http://localhost:8000/api/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'testuser',
                        password: 'testpass123'
                    }),
                });

                const data = await response.json();
                log('Login response: ' + JSON.stringify(data, null, 2));

                if (data.success) {
                    // Store token as AuthService would
                    sessionStorage.setItem('authToken', data.token);
                    sessionStorage.setItem('authUser', JSON.stringify(data.user));
                    log('‚úÖ Login successful, token stored');
                } else {
                    log('‚ùå Login failed: ' + data.error);
                }
            } catch (error) {
                log('‚ùå Login error: ' + error.message);
            }
        }

        async function testGraphQL() {
            try {
                const token = sessionStorage.getItem('authToken');
                if (!token) {
                    log('‚ùå No token found, please login first');
                    return;
                }

                log('üîÑ Testing GraphQL with token...');
                const response = await fetch('http://localhost:8000/graphql/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        query: `
                            query GetUserProfile {
                                userProfile {
                                    id
                                    user {
                                        id
                                        email
                                        firstName
                                        lastName
                                        isActive
                                    }
                                    middleName
                                    bio
                                    position
                                    department
                                    createdAt
                                    updatedAt
                                }
                            }
                        `
                    }),
                });

                const data = await response.json();
                log('GraphQL response: ' + JSON.stringify(data, null, 2));

                if (data.data && data.data.userProfile) {
                    log('‚úÖ GraphQL query successful!');
                } else if (data.errors) {
                    log('‚ùå GraphQL errors: ' + JSON.stringify(data.errors));
                } else {
                    log('‚ùå Unexpected GraphQL response');
                }
            } catch (error) {
                log('‚ùå GraphQL error: ' + error.message);
            }
        }

        // Auto-run tests
        log('Starting authentication tests...');
    </script>
</body>
</html>
