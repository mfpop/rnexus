<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat GraphQL Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .results {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Chat GraphQL Integration Test</h1>
        <p>This page tests the GraphQL chat functionality that we've implemented.</p>

        <div class="test-section">
            <h2>üìã Test 1: Load All Chats</h2>
            <button onclick="testLoadChats()">Test Load Chats</button>
            <div id="chats-result" class="results"></div>
        </div>

        <div class="test-section">
            <h2>üí¨ Test 2: Load Messages from a Chat</h2>
            <button onclick="testLoadMessages()">Test Load Messages</button>
            <div id="messages-result" class="results"></div>
        </div>

        <div class="test-section">
            <h2>üì§ Test 3: Send a Message</h2>
            <button onclick="testSendMessage()">Test Send Message</button>
            <div id="send-result" class="results"></div>
        </div>

        <div class="test-section">
            <h2>üîó Test 4: Frontend GraphQL Hook</h2>
            <p>This test simulates what the frontend chat component does:</p>
            <button onclick="testFrontendIntegration()">Test Frontend Integration</button>
            <div id="frontend-result" class="results"></div>
        </div>
    </div>

    <script>
        // Test configuration
        const GRAPHQL_URL = 'http://localhost:8000/graphql/';

        // Utility function to make GraphQL requests
        async function graphqlRequest(query, variables = {}) {
            try {
                const response = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: variables
                    })
                });

                const result = await response.json();

                if (result.errors) {
                    throw new Error('GraphQL Errors: ' + JSON.stringify(result.errors));
                }

                return result.data;
            } catch (error) {
                throw new Error('Network Error: ' + error.message);
            }
        }

        // Test 1: Load all chats
        async function testLoadChats() {
            const resultDiv = document.getElementById('chats-result');
            resultDiv.innerHTML = '<div class="loading">üîÑ Loading chats...</div>';

            try {
                const query = `
                    query {
                        allChats {
                            id
                            chatType
                            name
                            lastActivity
                            isActive
                        }
                    }
                `;

                const data = await graphqlRequest(query);
                const chats = data.allChats;

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Success! Found ${chats.length} chats</div>
                    <pre>${JSON.stringify(chats.slice(0, 3), null, 2)}</pre>
                    <small>Showing first 3 chats...</small>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test 2: Load messages from a specific chat
        async function testLoadMessages() {
            const resultDiv = document.getElementById('messages-result');
            resultDiv.innerHTML = '<div class="loading">üîÑ Loading messages...</div>';

            try {
                const query = `
                    query($chatId: String!, $chatType: String!) {
                        messages(chatId: $chatId, chatType: $chatType) {
                            id
                            senderId
                            senderName
                            content
                            messageType
                            timestamp
                            status
                        }
                    }
                `;

                const variables = {
                    chatId: "group_sales_&_marketing",
                    chatType: "group"
                };

                const data = await graphqlRequest(query, variables);
                const messages = data.messages;

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Success! Found ${messages.length} messages</div>
                    <pre>${JSON.stringify(messages.slice(0, 2), null, 2)}</pre>
                    <small>Showing first 2 messages...</small>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test 3: Send a new message
        async function testSendMessage() {
            const resultDiv = document.getElementById('send-result');
            resultDiv.innerHTML = '<div class="loading">üîÑ Sending test message...</div>';

            try {
                const mutation = `
                    mutation($chatId: String!, $chatType: String!, $senderId: String!, $senderName: String!, $content: String!, $messageType: String!) {
                        createMessage(
                            chatId: $chatId
                            chatType: $chatType
                            senderId: $senderId
                            senderName: $senderName
                            content: $content
                            messageType: $messageType
                        ) {
                            ok
                            message {
                                id
                                content
                                senderName
                                timestamp
                            }
                        }
                    }
                `;

                const variables = {
                    chatId: "group_sales_&_marketing",
                    chatType: "group",
                    senderId: "test_user",
                    senderName: "Test User",
                    content: "Hello from GraphQL test! üöÄ",
                    messageType: "text"
                };

                const data = await graphqlRequest(mutation, variables);
                const result = data.createMessage;

                if (result.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Message sent successfully!</div>
                        <pre>${JSON.stringify(result.message, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed to send message</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Test 4: Simulate frontend integration
        async function testFrontendIntegration() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.innerHTML = '<div class="loading">üîÑ Testing frontend-like integration...</div>';

            try {
                // Step 1: Load chats (like the frontend would do)
                console.log('üîÑ Step 1: Loading chats...');
                const chatsQuery = `
                    query {
                        allChats {
                            id
                            chatType
                            name
                        }
                    }
                `;
                const chatsData = await graphqlRequest(chatsQuery);
                const chats = chatsData.allChats;

                // Step 2: Load messages for the first chat
                console.log('üîÑ Step 2: Loading messages for first chat...');
                const firstChat = chats[0];
                const messagesQuery = `
                    query($chatId: String!, $chatType: String!) {
                        messages(chatId: $chatId, chatType: $chatType) {
                            id
                            content
                            senderName
                            timestamp
                        }
                    }
                `;
                const messagesData = await graphqlRequest(messagesQuery, {
                    chatId: firstChat.id,
                    chatType: firstChat.chatType.toLowerCase()
                });

                // Step 3: Display results
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Frontend integration test successful!</div>
                    <h4>üìã Loaded ${chats.length} chats:</h4>
                    <ul>
                        ${chats.slice(0, 3).map(chat => `<li>${chat.name} (${chat.chatType})</li>`).join('')}
                    </ul>
                    <h4>üí¨ Messages from "${firstChat.name}":</h4>
                    <ul>
                        ${messagesData.messages.slice(0, 3).map(msg => `<li><strong>${msg.senderName}:</strong> ${msg.content.substring(0, 50)}...</li>`).join('')}
                    </ul>
                    <p><strong>üéâ The chat page should now work with GraphQL!</strong></p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-run the first test when page loads
        window.addEventListener('load', () => {
            console.log('üîó Chat GraphQL Integration Test Page Loaded');
            console.log('üìç Frontend: http://localhost:5174');
            console.log('üìç Backend GraphQL: http://localhost:8000/graphql/');
        });
    </script>
</body>
</html>
